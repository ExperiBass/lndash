extends layout

block headContent
	title Query Route

block breadcrumb
	li.breadcrumb-item
		a(href='/') Home
	li.breadcrumb-item Tools
	li.breadcrumb-item Query Route
	
block content
	+pageTitle("Query Route")


	if (!session.admin)
		- var loginRequiredNote = "allow you to query lightning payment routes through the network.";
		include includes/login-required-alert.pug

	else

		form(method="post")
			.mb-3
				label.form-label(for="pubkey") Target Node Public Key
				input.form-control.form-control-lg(id="pubkey" name="pubkey" type="text" value=pubkey)

			if (pubkey)
				+card
					- var card_node_pubkey = pubkey;
					include includes/node-card.pug

			.d-flex
				.mb-3
					label.form-label(for="amount") Amount
					.input-group
						input.form-control.form-control-lg(type="number" id="amount" name="amountSat" value=amountSat)
						
						.input-group-text sat

			button.btn.btn-primary(type="submit")
				i.fas.fa-route.me-2
				span Query Route

		
			
		if (queryRouteError)
			hr.my-3

			.alert.alert-warning.shadow-sm
				h3.h6 No Route Found

				if (queryRouteError != null && queryRouteError.details)
					span.text-capitalize #{queryRouteError.details}

			if (false)
				pre
					code.json #{JSON.stringify(queryRouteError, null, 4)}

		else if (queryRouteResponse)
			hr.my-3

			if (false)
				pre
					code.json #{JSON.stringify(queryRouteResponse, null, 4)}

			.alert.alert-success.shadow-sm Route Found

			- var route = queryRouteResponse.routes[0];

			+contentSection("Summary")
				+summaryRow(4)
					+summaryItem("Total Cost", "The total amount to be transferred in milli-satoshis (the native unit on the lightning network), followed by the amount in your chosen unit")
						- var currencyValue = new Decimal(route.total_amt_msat).dividedBy(coinConfig.currencyUnitsByName.msat.multiplier);
						- var tempCurrencyFormatType = "msat";
						include includes/value-display.pug
						br
						span.text-muted.fs-75
							| (
							include includes/value-display.pug
							| )


					+summaryItem("Total Fees")
						if (parseInt(route.total_fees_msat) > 0)
							span.text-danger
								- var currencyValue = new Decimal(route.total_fees_msat).dividedBy(coinConfig.currencyUnitsByName.msat.multiplier);
								- var tempCurrencyFormatType = "msat";
								include includes/value-display.pug
								
						else
							span.text-success 0


					+summaryItem("Total Timelock")
						| #{route.total_time_lock.toLocaleString()}


					+summaryItem("Hops")
						| #{route.hops.length.toLocaleString()}




			+contentSection("Details")
				.d-flex
					.card.text-body.shadow-sm.me-3
						.card-header
							h3.h6.mb-0
								i.fas.fa-play-circle.me-2.fa-lg
								span Origin
						.card-body
							.fw-bold.mb-2 Node
							
							- var card_node_pubkey = lndRpc.internal_pubkey;
							include includes/node-card.pug

					each hop, hopIndex in route.hops
						
						.card.text-body.shadow-sm.me-3
							.card-header
								h3.h6.mb-0
									if (hopIndex == (route.hops.length - 1))
										i.fas.fa-check-circle.me-2.fa-lg
									else
										i.fas.fa-arrow-circle-right.me-2.fa-lg

									span Hop ##{(hopIndex + 1).toLocaleString()}

									if (hopIndex == (route.hops.length - 1))
										span  (Destination)
								
							.card-body
								.mb-3.border-bottom.pb-3
									.fw-bold.mb-2 Node
									- var card_node_pubkey = hop.pub_key;
									include includes/node-card.pug
									

								.mb-2
									.fw-bold Channel

									+channelId(hop.chan_id, true)
									
								div
									.fw-bold Fees
									
									if (parseInt(hop.fee_msat) > 0)
										span.text-danger +
											- var currencyValue = new Decimal(hop.fee_msat).dividedBy(coinConfig.currencyUnitsByName.msat.multiplier);
											- var tempCurrencyFormatType = "msat";
											include includes/value-display.pug
									else
										span.text-success 0

